<div class="profile-container">
  <!-- Header -->
  <div class="profile-header">
    <button class="btn-back" (click)="goBack()" title="Volver atr√°s">
      ‚Üê Volver
    </button>
    <h1>üë§ Mi Perfil</h1>
  </div>

  <!-- Contenido principal -->
  <div class="profile-content" *ngIf="currentUser">
    
    <!-- ============ SECCI√ìN 1: DATOS DEL PERFIL ============ -->
    <div class="profile-section">
      <div class="section-header">
        <div class="section-title-group">
          <h2>üìã Informaci√≥n Personal</h2>
          <span class="warning-badge">‚úÖ Rellena tus datos</span>
        </div>
        <button 
          class="btn-edit" 
          (click)="toggleEditMode()"
          [disabled]="isChangingPassword">
          {{ isEditingProfile ? '‚úñ Cancelar' : '‚úèÔ∏è Editar' }}
        </button>
      </div>

      <!-- Mensajes de √©xito/error -->
      <div *ngIf="successMessage" class="alert alert-success">
        {{ successMessage }}
      </div>
      <div *ngIf="errorMessage" class="alert alert-error">
        {{ errorMessage }}
      </div>

      <!-- Vista de lectura -->
      <div *ngIf="!isEditingProfile" class="profile-data">
        
        <div class="data-item">
          <label>Nombre Completo:</label>
          <div class="data-value">
            {{ currentUser.nombre }}
          </div>
        </div>

        <div class="data-item">
          <label>Email:</label>
          <div class="data-value">
            {{ currentUser.email }}
          </div>
        </div>

        <div class="data-item">
          <label>Apellidos:</label>
          <div class="data-value">
            {{ currentUser.apellidos || 'No especificado' }}
          </div>
        </div>

        <div class="data-item">
          <label>DNI/CI:</label>
          <div class="data-value">
            {{ currentUser.dni || 'No especificado' }}
          </div>
        </div>

        <div class="data-item">
          <label>Tel√©fono:</label>
          <div class="data-value">
            {{ currentUser.telefono || 'No especificado' }}
          </div>
        </div>

        <div class="data-item">
          <label>Direcci√≥n:</label>
          <div class="data-value">
            {{ currentUser.direccion || 'No especificado' }}
          </div>
        </div>

        <div class="data-item">
          <label>Estado:</label>
          <div class="data-value">
            <span class="badge badge-success">
              ‚úÖ Activo
            </span>
          </div>
        </div>

        <div class="data-item">
          <label>Miembro desde:</label>
          <div class="data-value">
            {{ currentUser.fechaCreacion ? (currentUser.fechaCreacion | date: 'short') : 'No disponible' }}
          </div>
        </div>
      </div>

      <!-- Formulario de edici√≥n -->
      <form [formGroup]="profileForm" *ngIf="isEditingProfile" class="profile-form">
        
        <!-- Nombre -->
        <div class="form-group">
          <label for="nombre">Nombre Completo *</label>
          <input 
            id="nombre"
            type="text" 
            formControlName="nombre" 
            class="form-control"
            placeholder="Ingresa tu nombre completo">
          <div class="error-message" *ngIf="profileForm.get('nombre')?.touched">
            {{ getErrorMessage('nombre', profileForm) }}
          </div>
        </div>

        <!-- Email -->
        <div class="form-group">
          <label for="email">Email *</label>
          <input 
            id="email"
            type="email" 
            formControlName="email" 
            class="form-control"
            placeholder="tu@email.com">
          <div class="error-message" *ngIf="profileForm.get('email')?.touched">
            {{ getErrorMessage('email', profileForm) }}
          </div>
        </div>

        <!-- Apellidos -->
        <div class="form-group">
          <label for="apellidos">Apellidos</label>
          <input 
            id="apellidos"
            type="text" 
            formControlName="apellidos" 
            class="form-control"
            placeholder="Tus apellidos">
        </div>

        <!-- DNI -->
        <div class="form-group">
          <label for="dni">DNI/CI</label>
          <input 
            id="dni"
            type="text" 
            formControlName="dni" 
            class="form-control"
            placeholder="Tu documento de identidad">
        </div>

        <!-- Tel√©fono -->
        <div class="form-group">
          <label for="telefono">Tel√©fono</label>
          <input 
            id="telefono"
            type="text" 
            formControlName="telefono" 
            class="form-control"
            placeholder="Tu n√∫mero de tel√©fono">
          <div class="error-message" *ngIf="profileForm.get('telefono')?.touched">
            {{ getErrorMessage('telefono', profileForm) }}
          </div>
        </div>

        <!-- Direcci√≥n -->
        <div class="form-group">
          <label for="direccion">Direcci√≥n</label>
          <textarea 
            id="direccion"
            formControlName="direccion" 
            class="form-control"
            placeholder="Tu direcci√≥n completa"
            rows="3"></textarea>
        </div>

        <!-- Botones -->
        <div class="form-actions">
          <button 
            type="button" 
            class="btn btn-primary"
            (click)="guardarCambiosPerfil()"
            [disabled]="profileForm.invalid">
            üíæ Guardar Cambios
          </button>
          <button 
            type="button" 
            class="btn btn-secondary"
            (click)="toggleEditMode()">
            ‚úñ Cancelar
          </button>
        </div>
      </form>
    </div>

    <!-- ============ SECCI√ìN 2: CAMBIAR CONTRASE√ëA ============ -->
    <div class="profile-section">
      <div class="section-header">
        <h2>üîê Cambiar Contrase√±a</h2>
        <button 
          class="btn-edit" 
          (click)="togglePasswordMode()"
          [disabled]="isEditingProfile">
          {{ isChangingPassword ? '‚úñ Cancelar' : 'üîë Cambiar' }}
        </button>
      </div>

      <!-- Mensajes de √©xito/error -->
      <div *ngIf="passwordSuccessMessage" class="alert alert-success">
        {{ passwordSuccessMessage }}
      </div>
      <div *ngIf="passwordErrorMessage" class="alert alert-error">
        {{ passwordErrorMessage }}
      </div>

      <!-- Vista de lectura (cuando no est√° editando contrase√±a) -->
      <div *ngIf="!isChangingPassword && !showPasswordRecoveryForm" class="password-info">
        <p class="info-text">
          üõ°Ô∏è Mant√©n tu contrase√±a segura. C√°mbiala regularmente para proteger tu cuenta.
        </p>
      </div>

      <!-- ============ PANTALLA DE RECUPERACI√ìN DE CONTRASE√ëA (sin formulario de cambio) ============ -->
      <div *ngIf="showPasswordRecoveryForm && !isChangingPassword" class="recovery-section">
        
        <!-- Mensaje de env√≠o de c√≥digo -->
        <div class="alert alert-info" *ngIf="!recoveryCodeCorrect && !showPasswordResetScreen">
          üìß Se ha enviado un c√≥digo de recuperaci√≥n a <strong>{{ currentUser.email }}</strong>. 
          Ingresa los 3 d√≠gitos del c√≥digo.
        </div>

        <!-- Entrada de c√≥digo -->
        <div *ngIf="!recoveryCodeCorrect && !showPasswordResetScreen" class="code-input-section">
          <label>C√≥digo de Recuperaci√≥n (3 d√≠gitos) *</label>
          <div class="code-input-group">
            <input 
              type="text" 
              [(ngModel)]="recoveryCodeInput"
              maxlength="3"
              placeholder="000"
              class="code-input"
              [disabled]="recoveryExpired"
              (keyup.enter)="verificarCodigoRecuperacion()">
            <span class="code-timer" [ngClass]="recoveryCountdown <= 10 ? 'timer-danger' : ''">
              ‚è±Ô∏è {{ recoveryCountdown }}s
            </span>
          </div>
          
          <div *ngIf="recoveryExpired" class="alert alert-error">
            ‚è∞ El c√≥digo ha expirado. Solicita uno nuevo.
          </div>

          <div class="button-group">
            <button 
              type="button" 
              class="btn btn-primary"
              (click)="verificarCodigoRecuperacion()"
              [disabled]="recoveryExpired || recoveryCodeInput.length !== 3">
              ‚úì Verificar C√≥digo
            </button>
            <button 
              type="button" 
              class="btn btn-secondary"
              (click)="cancelarRecuperacion()">
              ‚úñ Cancelar
            </button>
          </div>
        </div>

        <!-- Pantalla de c√≥digo verificado - mostrar c√≥digo para usar como contrase√±a -->
        <div *ngIf="showPasswordResetScreen && recoveryCodeCorrect" class="code-display-section">
          <div class="alert alert-success">
            ‚úÖ C√≥digo verificado correctamente!
          </div>

          <p class="info-text">Usa el c√≥digo abajo como tu contrase√±a actual. Disponible por {{ codeExpirationCountdown }} segundos.</p>

          <div class="code-timer-display">
            <span class="code-value">{{ recoveryCode }}</span>
            <span class="code-expiration" [ngClass]="codeExpirationCountdown <= 15 ? 'timer-danger' : ''">
              El c√≥digo expira en {{ codeExpirationCountdown }}s
            </span>
          </div>

          <div class="button-group">
            <button 
              type="button" 
              class="btn btn-primary"
              (click)="togglePasswordMode()">
              üîê Usar C√≥digo para Cambiar Contrase√±a
            </button>
            <button 
              type="button" 
              class="btn btn-secondary"
              (click)="cancelarRecuperacion()">
              ‚úñ Cancelar
            </button>
          </div>
        </div>
      </div>

      <!-- Formulario de cambio de contrase√±a -->
      <form [formGroup]="passwordForm" *ngIf="isChangingPassword" class="password-form">
        
        <!-- Contrase√±a Actual / Contador de C√≥digo -->
        <div class="form-group">
          <label for="contrasenaActual">
            {{ codeReplacesPassword ? 'C√≥digo de Recuperaci√≥n' : 'Contrase√±a Actual' }} *
          </label>
          
          <!-- Si el c√≥digo reemplaza la contrase√±a -->
          <div *ngIf="codeReplacesPassword" class="code-replacement-section">
            <div class="code-timer-display">
              <span class="code-value">{{ recoveryCode }}</span>
              <span class="code-expiration" [ngClass]="codeExpirationCountdown <= 15 ? 'timer-danger' : ''">
                El c√≥digo expira en {{ codeExpirationCountdown }}s
              </span>
            </div>
            <p class="info-text">Este c√≥digo ser√° usado como tu contrase√±a actual para actualizar tu contrase√±a.</p>
          </div>
          
          <!-- Si es el flujo normal -->
          <div *ngIf="!codeReplacesPassword" class="password-input-group">
            <input 
              id="contrasenaActual"
              [type]="showCurrentPassword ? 'text' : 'password'" 
              formControlName="contrasenaActual" 
              class="form-control"
              placeholder="Ingresa tu contrase√±a actual">
            <button 
              type="button" 
              class="btn-toggle-password" 
              (click)="toggleCurrentPasswordVisibility()"
              title="Mostrar/Ocultar contrase√±a">
              {{ showCurrentPassword ? 'üôà' : 'üëÅÔ∏è' }}
            </button>
          </div>
          <div class="error-message" *ngIf="!codeReplacesPassword && passwordForm.get('contrasenaActual')?.touched">
            {{ getErrorMessage('contrasenaActual', passwordForm) }}
          </div>
        </div>

        <!-- Nueva Contrase√±a -->
        <div class="form-group">
          <label for="contrasenaNew">Nueva Contrase√±a *</label>
          <div class="password-input-group">
            <input 
              id="contrasenaNew"
              [type]="showNewPassword ? 'text' : 'password'" 
              formControlName="contrasenaNew" 
              class="form-control"
              placeholder="Ingresa una nueva contrase√±a">
            <button 
              type="button" 
              class="btn-toggle-password" 
              (click)="toggleNewPasswordVisibility()"
              title="Mostrar/Ocultar contrase√±a">
              {{ showNewPassword ? 'üôà' : 'üëÅÔ∏è' }}
            </button>
          </div>
          <div class="error-message" *ngIf="passwordForm.get('contrasenaNew')?.touched">
            {{ getErrorMessage('contrasenaNew', passwordForm) }}
          </div>
        </div>

        <!-- Confirmar Nueva Contrase√±a -->
        <div class="form-group">
          <label for="confirmarContrasena">Confirmar Nueva Contrase√±a *</label>
          <div class="password-input-group">
            <input 
              id="confirmarContrasena"
              [type]="showConfirmPassword ? 'text' : 'password'" 
              formControlName="confirmarContrasena" 
              class="form-control"
              placeholder="Confirma tu nueva contrase√±a">
            <button 
              type="button" 
              class="btn-toggle-password" 
              (click)="toggleConfirmPasswordVisibility()"
              title="Mostrar/Ocultar contrase√±a">
              {{ showConfirmPassword ? 'üôà' : 'üëÅÔ∏è' }}
            </button>
          </div>
          <div class="error-message" *ngIf="passwordForm.get('confirmarContrasena')?.touched">
            {{ getErrorMessage('confirmarContrasena', passwordForm) }}
          </div>
        </div>

        <!-- Error personalizado para contrase√±as que no coinciden -->
        <div *ngIf="passwordForm.hasError('passwordsMismatch') && isChangingPassword" class="error-message">
          ‚ö†Ô∏è Las nuevas contrase√±as no coinciden
        </div>

        <!-- Botones -->
        <div class="form-actions">
          <button 
            type="button" 
            class="btn btn-primary"
            (click)="cambiarContrasena()"
            [disabled]="passwordForm.invalid">
            üîê Actualizar Contrase√±a
          </button>
          <button 
            type="button" 
            class="btn btn-secondary"
            (click)="togglePasswordMode()">
            ‚úñ Cancelar
          </button>
        </div>

        <!-- Link de olvid√© contrase√±a -->
        <div class="forgot-password-section">
          <p class="forgot-text">
            <a href="#" (click)="mostrarMensajeRecuperacion(); $event.preventDefault()" class="forgot-password-link">
              ¬øOlvidaste tu contrase√±a?
            </a>
          </p>
        </div>
      </form>
    </div>

  </div>

  <!-- Loading state -->
  <div *ngIf="!currentUser" class="loading">
    <p>Cargando perfil...</p>
  </div>
</div>
