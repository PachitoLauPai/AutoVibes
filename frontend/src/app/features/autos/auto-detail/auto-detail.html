<div class="auto-detail-page">

  <!-- LOADING -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-3 text-muted">Cargando informaci√≥n del auto...</p>
  </div>

  <!-- ERROR -->
  <div *ngIf="error && !loading" class="alert alert-danger alert-dismissible fade show" role="alert">
    ‚ùå {{ error }}
    <button type="button" class="btn-close" (click)="error = ''; volverALista()"></button>
  </div>

  <!-- AUTO DETAIL CONTENT -->
  <div *ngIf="auto && !loading" class="auto-detail-container">

    <!-- BREADCRUMB -->
    <div class="breadcrumb-section">
      <button class="btn-back" (click)="volverALista()">
        ‚Üê Volver a la lista
      </button>
    </div>

    <div class="auto-detail-layout">
      <!-- LEFT COLUMN - IMAGE GALLERY -->
      <div class="gallery-column">
        <div class="gallery-container">
          <div class="gallery-layout">
            <!-- Main Image (Left) -->
            <div class="main-image-section">
              <div class="main-image-wrapper" (click)="openImageModal(currentImageIndex)">
                <img [src]="getCurrentImage()" [alt]="auto.modelo" (error)="handleImageError($event)" class="main-image"
                  style="cursor: pointer;">

                <!-- Image Counter -->
                <div class="image-counter" *ngIf="auto.imagenes && auto.imagenes.length > 0">
                  üì∑ {{ auto.imagenes.length }}
                </div>
              </div>
            </div>

            <!-- Thumbnail Gallery (Right) -->
            <div class="thumbnail-section" *ngIf="auto.imagenes && auto.imagenes.length > 1">
              <div class="thumbnail-grid">
                <img *ngFor="let img of auto.imagenes.slice(0, 4); let i = index" [src]="img"
                  [alt]="'Miniatura ' + (i + 1)" (click)="goToImage(i)" (error)="handleImageError($event)"
                  class="thumbnail" [class.active]="i === currentImageIndex">
                <button class="thumbnail-view-more" *ngIf="auto.imagenes.length > 4"
                  (click)="openImageModal(currentImageIndex)">
                  Ver fotos
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN - AUTO INFO -->
      <div class="info-column">
        <!-- Title -->
        <h1 class="auto-title">{{ auto.marca?.nombre }} {{ auto.modelo }} {{ auto.anio }}</h1>

        <!-- Key Specs Row -->
        <div class="key-specs-row">
          <div class="spec-item">
            <div class="spec-icon">üìÖ</div>
            <div class="spec-content">
              <div class="spec-label">A√±o modelo</div>
              <div class="spec-value">{{ auto.anio }}</div>
            </div>
          </div>
          <div class="spec-item">
            <div class="spec-content">
              <div class="spec-label">Kilometraje</div>
              <div class="spec-value">{{ auto.kilometraje | number }} km</div>
            </div>
          </div>
          <div class="spec-item">
            <div class="spec-content">
              <div class="spec-label">Transmisi√≥n</div>
              <div class="spec-value">{{ auto.transmision?.nombre }}</div>
            </div>
          </div>
        </div>

        <!-- Price -->
        <div class="price-section">
          <div class="price-label">Precio</div>
          <div class="price-value">US$ {{ auto.precio | number:'1.0-0' }}</div>
        </div>

        <!-- Contact Section -->
        <div class="contact-section">
          <div class="contact-divider"></div>
          <div class="contact-header">Cont√°ctate con el anunciante</div>

          <div class="dealer-info" *ngIf="auto.concesionario">
            <div class="dealer-logo">
              <div class="dealer-logo-circle">{{ auto.concesionario.nombre.charAt(0) }}</div>
            </div>
            <div class="dealer-details">
              <div class="dealer-name">{{ auto.concesionario.nombre }}</div>
              <div class="dealer-phone" *ngIf="auto.concesionario.telefono">
                {{ auto.concesionario.telefono }}
              </div>
            </div>
          </div>

          <!-- Buttons Container -->
          <div class="contact-buttons" *ngIf="auto.disponible">
            <!-- WhatsApp Button -->
            <button class="btn-whatsapp" *ngIf="auto.concesionario?.telefono" (click)="contactarWhatsApp()">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="white" class="whatsapp-icon">
                <path
                  d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z" />
              </svg>
              M√°s informaci√≥n
            </button>

            <!-- Contact Button -->
            <button class="btn-contact" (click)="openContactModal()">
              CONTACTAR
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Technical Specifications Table -->
    <div class="specifications-section">
      <h2 class="section-title">Especificaciones t√©cnicas</h2>
      <div class="spec-table-container">
        <table class="spec-table">
          <tbody>
            <tr>
              <td class="spec-label">Marca</td>
              <td class="spec-value">{{ auto.marca?.nombre }}</td>
            </tr>
            <tr>
              <td class="spec-label">Modelo</td>
              <td class="spec-value">{{ auto.modelo }}</td>
            </tr>
            <tr>
              <td class="spec-label">A√±o de fabricaci√≥n</td>
              <td class="spec-value">{{ auto.anio }}</td>
            </tr>
            <tr>
              <td class="spec-label">Categor√≠a</td>
              <td class="spec-value">{{ auto.categoria?.nombre }}</td>
            </tr>
            <tr>
              <td class="spec-label">Combustible</td>
              <td class="spec-value">{{ auto.combustible?.nombre }}</td>
            </tr>

            <tr>
              <td class="spec-label">Color</td>
              <td class="spec-value">{{ auto.color }}</td>
            </tr>
            <tr>
              <td class="spec-label">Transmisi√≥n</td>
              <td class="spec-value">{{ auto.transmision?.nombre }}</td>
            </tr>
            <tr>
              <td class="spec-label">Kilometraje</td>
              <td class="spec-value">{{ auto.kilometraje | number }} km</td>
            </tr>
            <tr>
              <td class="spec-label">Condici√≥n</td>
              <td class="spec-value">{{ auto.condicion?.nombre }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- CONTACT MODAL -->
<div class="modal fade" id="contactModal" tabindex="-1" [class.show]="showContactModal"
  [style.display]="showContactModal ? 'block' : 'none'" role="dialog">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <!-- MODAL HEADER -->
      <div class="modal-header">
        <h5 class="modal-title">
          Contactar sobre: {{ auto?.marca?.nombre }} {{ auto?.modelo }}
        </h5>
        <button type="button" class="btn-close" (click)="closeContactModal()"></button>
      </div>

      <!-- MODAL BODY -->
      <div class="modal-body">
        <form (ngSubmit)="enviarContacto()">

          <!-- NOMBRE -->
          <div class="mb-3">
            <label for="nombre" class="form-label fw-bold">Nombre completo *</label>
            <input type="text" class="form-control" id="nombre" [(ngModel)]="contactData.nombre" name="nombre"
              placeholder="Juan P√©rez Garc√≠a" required>
          </div>

          <!-- DNI -->
          <div class="mb-3">
            <label for="dni" class="form-label fw-bold">DNI *</label>
            <input type="text" class="form-control" id="dni" [(ngModel)]="contactData.dni" name="dni"
              placeholder="12345678" maxlength="8" required>
          </div>

          <!-- EMAIL -->
          <div class="mb-3">
            <label for="email" class="form-label fw-bold">Email *</label>
            <input type="email" class="form-control" id="email" [(ngModel)]="contactData.email" name="email"
              placeholder="juan@example.com" required>
          </div>

          <!-- TEL√âFONO -->
          <div class="mb-3">
            <label for="telefono" class="form-label fw-bold">Tel√©fono (Per√∫) *</label>
            <div class="input-group">
              <span class="input-group-text">üáµüá™ +51</span>
              <input type="text" class="form-control" id="telefono" [(ngModel)]="contactData.telefono" name="telefono"
                placeholder="987654321" maxlength="9" inputmode="numeric" appNumericInput
                title="Debe ser un n√∫mero de 9 d√≠gitos" required>
            </div>
            <small class="text-muted d-block mt-1">Ingresa 9 d√≠gitos comenzando con 9</small>
          </div>

          <!-- MENSAJE -->
          <div class="mb-3">
            <label for="mensaje" class="form-label fw-bold">Mensaje *</label>
            <textarea class="form-control" id="mensaje" [(ngModel)]="contactData.mensaje" name="mensaje" rows="4"
              placeholder="Escribe tu mensaje aqu√≠..." required></textarea>
          </div>

          <!-- MODAL FOOTER -->
          <div class="d-flex gap-2 mt-4">
            <button type="button" class="btn btn-secondary flex-grow-1" (click)="closeContactModal()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-success flex-grow-1">
              üí¨ Contactar a trav√©s de WhatsApp
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- MODAL BACKDROP -->
<div class="modal-backdrop fade" [class.show]="showContactModal" *ngIf="showContactModal" (click)="closeContactModal()">
</div>

<!-- IMAGE MODAL WITH ZOOM -->
<div class="image-modal" [class.show]="showImageModal" *ngIf="showImageModal" (click)="closeImageModal()">
  <div class="image-modal-content" (click)="$event.stopPropagation()">
    <button class="image-modal-close" (click)="closeImageModal()">√ó</button>

    <!-- Zoom Controls -->
    <div class="zoom-controls">
      <button class="zoom-btn" (click)="zoomIn()">+</button>
      <button class="zoom-btn" (click)="zoomOut()">-</button>
      <button class="zoom-btn" (click)="resetZoom()">Reset</button>
    </div>

    <!-- Image Container -->
    <div class="image-modal-container">
      <img [src]="getModalImage()" [alt]="auto?.modelo" class="modal-image"
        [style.transform]="'scale(' + imageZoom + ')'" (error)="handleImageError($event)">
    </div>

    <!-- Navigation Arrows -->
    <button class="modal-nav-arrow modal-nav-prev" *ngIf="(auto?.imagenes?.length ?? 0) > 1" (click)="prevModalImage()">
      ‚Äπ
    </button>
    <button class="modal-nav-arrow modal-nav-next" *ngIf="(auto?.imagenes?.length ?? 0) > 1" (click)="nextModalImage()">
      ‚Ä∫
    </button>

    <!-- Image Counter -->
    <div class="modal-image-counter" *ngIf="(auto?.imagenes?.length ?? 0) > 1">
      {{ modalImageIndex + 1 }} / {{ auto?.imagenes?.length ?? 0 }}
    </div>

    <!-- Thumbnail Strip -->
    <div class="modal-thumbnails" *ngIf="(auto?.imagenes?.length ?? 0) > 1">
      <img *ngFor="let img of auto?.imagenes; let i = index" [src]="img" [alt]="'Miniatura ' + (i + 1)"
        (click)="goToModalImage(i)" (error)="handleImageError($event)" class="modal-thumbnail"
        [class.active]="i === modalImageIndex">
    </div>
  </div>
</div>