<!-- Solo mostrar para clientes/no logueados -->
<div *ngIf="!authService.isAdmin()" class="autos-page">
  <div class="container-fluid py-4">
    <div class="row">
      
      <!-- SIDEBAR IZQUIERDO - FILTROS -->
      <div class="col-lg-3 col-md-4 filters-sidebar">
        <div class="filters-container">
          
          <!-- Filtro CondiciÃ³n -->
          <div class="filter-section">
            <div class="filter-header" (click)="toggleFilter('condicion')">
              <h6 class="mb-0">CondiciÃ³n</h6>
              <span class="filter-arrow">{{ filtersOpen.condicion ? 'â–²' : 'â–¼' }}</span>
            </div>
            <div class="filter-content" [class.collapsed]="!filtersOpen.condicion">
              <div class="filter-item" *ngFor="let condicion of condiciones">
                <label class="filter-checkbox">
                  <input type="checkbox" 
                         [value]="condicion.id"
                         [checked]="filtroCondicion === condicion.id.toString()"
                         (change)="toggleCondicion(condicion.id)">
                  <span>{{ condicion.nombre }}</span>
                  <span class="filter-count">({{ getCountByCondicion(condicion.id) }})</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Filtro Marca -->
          <div class="filter-section">
            <div class="filter-header" (click)="toggleFilter('marca')">
              <h6 class="mb-0">Marca</h6>
              <span class="filter-arrow">{{ filtersOpen.marca ? 'â–²' : 'â–¼' }}</span>
            </div>
            <div class="filter-content" [class.collapsed]="!filtersOpen.marca">
              <div class="filter-item" *ngFor="let marca of marcas.slice(0, 10)">
                <label class="filter-checkbox">
                  <input type="checkbox" 
                         [value]="marca.id"
                         [checked]="filtroMarca === marca.id.toString()"
                         (change)="toggleMarca(marca.id)">
                  <span>{{ marca.nombre }}</span>
                  <span class="filter-count">({{ getCountByMarca(marca.id) }})</span>
                </label>
              </div>
              <a href="#" class="more-options" *ngIf="marcas.length > 10">MÃ¡s Opciones</a>
            </div>
          </div>

          <!-- Filtro Precio -->
          <div class="filter-section">
            <div class="filter-header" (click)="toggleFilter('precio')">
              <h6 class="mb-0">Precio</h6>
              <span class="filter-arrow">{{ filtersOpen.precio ? 'â–²' : 'â–¼' }}</span>
            </div>
            <div class="filter-content" [class.collapsed]="!filtersOpen.precio">
              <div class="filter-item">
                <label class="filter-checkbox">
                  <input type="checkbox" (change)="setPrecioRange(0, 5000)">
                  <span>Hasta S/ 5,000</span>
                  <span class="filter-count">({{ getCountByPrecio(0, 5000) }})</span>
                </label>
              </div>
              <div class="filter-item">
                <label class="filter-checkbox">
                  <input type="checkbox" (change)="setPrecioRange(5000, 10000)">
                  <span>S/ 5,000 a S/ 10,000</span>
                  <span class="filter-count">({{ getCountByPrecio(5000, 10000) }})</span>
                </label>
              </div>
              <div class="filter-item">
                <label class="filter-checkbox">
                  <input type="checkbox" (change)="setPrecioRange(10000, 20000)">
                  <span>S/ 10,000 a S/ 20,000</span>
                  <span class="filter-count">({{ getCountByPrecio(10000, 20000) }})</span>
                </label>
              </div>
              <div class="filter-item">
                <label class="filter-checkbox">
                  <input type="checkbox" (change)="setPrecioRange(20000, 35000)">
                  <span>S/ 20,000 a S/ 35,000</span>
                  <span class="filter-count">({{ getCountByPrecio(20000, 35000) }})</span>
                </label>
              </div>
              <div class="filter-item">
                <label class="filter-checkbox">
                  <input type="checkbox" (change)="setPrecioRange(35000, null)">
                  <span>S/ 35,000 a mÃ¡s</span>
                  <span class="filter-count">({{ getCountByPrecio(35000, null) }})</span>
                </label>
              </div>
              <div class="custom-range mt-3">
                <div class="row g-2">
                  <div class="col-6">
                    <input type="number" class="form-control form-control-sm" 
                           [(ngModel)]="filtroPrecioMin" 
                           (input)="aplicarFiltros()"
                           placeholder="Desde">
                  </div>
                  <div class="col-6">
                    <input type="number" class="form-control form-control-sm" 
                           [(ngModel)]="filtroPrecioMax" 
                           (input)="aplicarFiltros()"
                           placeholder="Hasta">
                  </div>
                </div>
                <button class="btn btn-sm btn-primary w-100 mt-2" (click)="aplicarFiltros()">
                  â†’
                </button>
              </div>
            </div>
          </div>

          <!-- Filtro AÃ±o -->
          <div class="filter-section">
            <div class="filter-header" (click)="toggleFilter('anio')">
              <h6 class="mb-0">AÃ±o</h6>
              <span class="filter-arrow">{{ filtersOpen.anio ? 'â–²' : 'â–¼' }}</span>
            </div>
            <div class="filter-content" [class.collapsed]="!filtersOpen.anio">
              <div class="filter-item">
                <label class="filter-checkbox">
                  <input type="checkbox" (change)="setAnioRange(2018, 2024)">
                  <span>2018 a 2024</span>
                  <span class="filter-count">({{ getCountByAnio(2018, 2024) }})</span>
                </label>
              </div>
              <div class="filter-item">
                <label class="filter-checkbox">
                  <input type="checkbox" (change)="setAnioRange(2012, 2017)">
                  <span>2012 a 2017</span>
                  <span class="filter-count">({{ getCountByAnio(2012, 2017) }})</span>
                </label>
              </div>
              <div class="filter-item">
                <label class="filter-checkbox">
                  <input type="checkbox" (change)="setAnioRange(2006, 2011)">
                  <span>2006 a 2011</span>
                  <span class="filter-count">({{ getCountByAnio(2006, 2011) }})</span>
                </label>
              </div>
              <div class="custom-range mt-3">
                <div class="row g-2">
                  <div class="col-6">
                    <input type="number" class="form-control form-control-sm" 
                           [(ngModel)]="filtroAnioMin" 
                           (input)="aplicarFiltros()"
                           placeholder="Desde">
                  </div>
                  <div class="col-6">
                    <input type="number" class="form-control form-control-sm" 
                           [(ngModel)]="filtroAnioMax" 
                           (input)="aplicarFiltros()"
                           placeholder="Hasta">
                  </div>
                </div>
                <button class="btn btn-sm btn-primary w-100 mt-2" (click)="aplicarFiltros()">
                  â†’
                </button>
              </div>
            </div>
          </div>

          <!-- Filtro KilÃ³metros -->
          <div class="filter-section">
            <div class="filter-header" (click)="toggleFilter('kilometraje')">
              <h6 class="mb-0">KilÃ³metros</h6>
              <span class="filter-arrow">{{ filtersOpen.kilometraje ? 'â–²' : 'â–¼' }}</span>
            </div>
            <div class="filter-content" [class.collapsed]="!filtersOpen.kilometraje">
              <div class="filter-item">
                <label class="filter-checkbox">
                  <input type="checkbox" (change)="setKilometrajeMax(15000)">
                  <span>Hasta 15,000 Kms</span>
                  <span class="filter-count">({{ getCountByKilometraje(0, 15000) }})</span>
                </label>
              </div>
              <div class="filter-item">
                <label class="filter-checkbox">
                  <input type="checkbox" (change)="setKilometrajeMax(30000)">
                  <span>15,000 a 30,000 Kms</span>
                  <span class="filter-count">({{ getCountByKilometraje(15000, 30000) }})</span>
                </label>
              </div>
              <div class="filter-item">
                <label class="filter-checkbox">
                  <input type="checkbox" (change)="setKilometrajeMax(50000)">
                  <span>30,000 a 50,000 Kms</span>
                  <span class="filter-count">({{ getCountByKilometraje(30000, 50000) }})</span>
                </label>
              </div>
              <div class="filter-item">
                <label class="filter-checkbox">
                  <input type="checkbox" (change)="setKilometrajeMax(100000)">
                  <span>50,000 a 100,000 Kms</span>
                  <span class="filter-count">({{ getCountByKilometraje(50000, 100000) }})</span>
                </label>
              </div>
              <div class="filter-item">
                <label class="filter-checkbox">
                  <input type="checkbox" (change)="setKilometrajeMax(null)">
                  <span>100,000 Kms a mÃ¡s</span>
                  <span class="filter-count">({{ getCountByKilometraje(100000, null) }})</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Filtro TransmisiÃ³n -->
          <div class="filter-section">
            <div class="filter-header" (click)="toggleFilter('transmision')">
              <h6 class="mb-0">TransmisiÃ³n</h6>
              <span class="filter-arrow">{{ filtersOpen.transmision ? 'â–²' : 'â–¼' }}</span>
            </div>
            <div class="filter-content" [class.collapsed]="!filtersOpen.transmision">
              <div class="filter-item" *ngFor="let transmision of transmisiones">
                <label class="filter-checkbox">
                  <input type="checkbox" 
                         [value]="transmision.id"
                         [checked]="filtroTransmision === transmision.id.toString()"
                         (change)="toggleTransmision(transmision.id)">
                  <span>{{ transmision.nombre }}</span>
                  <span class="filter-count">({{ getCountByTransmision(transmision.id) }})</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Filtro CategorÃ­a -->
          <div class="filter-section">
            <div class="filter-header" (click)="toggleFilter('categoria')">
              <h6 class="mb-0">CategorÃ­a</h6>
              <span class="filter-arrow">{{ filtersOpen.categoria ? 'â–²' : 'â–¼' }}</span>
            </div>
            <div class="filter-content" [class.collapsed]="!filtersOpen.categoria">
              <div class="category-grid">
                <div class="category-item" *ngFor="let categoria of categorias" 
                     (click)="toggleCategoria(categoria.id)"
                     [class.active]="filtroCategoria === categoria.id.toString()">
                  <div class="category-icon">
                    <img [src]="getCategoryImage(categoria.nombre)" 
                         [alt]="categoria.nombre"
                         (error)="onCategoryImageError($event, categoria.nombre)"
                         class="category-image">
                  </div>
                  <div class="category-name">{{ categoria.nombre }}</div>
                  <div class="category-count">({{ getCountByCategoria(categoria.id) }})</div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- ÃREA PRINCIPAL - CARDS DE AUTOS -->
      <div class="col-lg-9 col-md-8 autos-main">
        
        <!-- Loading -->
        <div *ngIf="loading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-3 text-muted">Cargando autos...</p>
        </div>

        <!-- Error -->
        <div *ngIf="error && !loading" class="alert alert-danger">
          {{ error }}
        </div>

        <!-- Grid de Autos -->
        <div class="autos-grid" *ngIf="!loading && !error">
          <div class="auto-card-item" *ngFor="let auto of autosFiltrados">
            <div class="auto-card">
              
              <!-- Imagen con Badge y Carrusel -->
              <div class="auto-image-wrapper">
                <img [src]="getCurrentImage(auto)" 
                     [alt]="auto.modelo"
                     [attr.data-auto-id]="auto.id"
                     (error)="onImageError($event, auto)"
                     class="auto-main-image">
                
                <!-- Badge de CondiciÃ³n -->
                <div class="auto-badge" [class.badge-nuevo]="esNuevo(auto)" 
                     [class.badge-usado]="!esNuevo(auto)">
                  {{ auto.condicion?.nombre === 'NUEVO' ? 'NUEVO' : 'USADO' }}
                </div>

                <!-- Contador de ImÃ¡genes -->
                <div class="image-counter" *ngIf="auto.imagenes && auto.imagenes.length > 0">
                  ðŸ“· {{ auto.imagenes.length }}
                </div>

                <!-- Flechas de NavegaciÃ³n (si hay mÃ¡s de 1 imagen) -->
                <button class="carousel-nav prev" *ngIf="auto.imagenes && auto.imagenes.length > 1"
                        (click)="prevImage(auto, $event)"
                        type="button">
                  â€¹
                </button>
                <button class="carousel-nav next" *ngIf="auto.imagenes && auto.imagenes.length > 1"
                        (click)="nextImage(auto, $event)"
                        type="button">
                  â€º
                </button>
              </div>

              <!-- InformaciÃ³n del Auto -->
              <div class="auto-info">
                <h3 class="auto-title">{{ auto.marca?.nombre }} {{ auto.modelo }} {{ auto.anio }}</h3>
                
                <div class="auto-specs">
                  <span *ngIf="auto.combustible">{{ auto.combustible.nombre }}</span>
                  <span *ngIf="auto.combustible && auto.transmision"> | </span>
                  <span *ngIf="auto.transmision">{{ auto.transmision.nombre }}</span>
                </div>

                <div class="auto-details">
                  <div class="auto-detail-item">
                    <strong>Kilometraje:</strong> {{ auto.kilometraje | number }} Kms
                  </div>
                </div>

                <!-- Precio -->
                <div class="auto-price">
                  <div class="price-main">S/ {{ auto.precio | number:'1.0-0' }}</div>
                </div>

                <!-- Concesionario (si existe) -->
                <div class="auto-dealer" *ngIf="auto.concesionario">
                  <div class="dealer-logo">{{ auto.concesionario.nombre }}</div>
                </div>

                <!-- BotÃ³n Contactar -->
                <button class="btn-contactar" 
                        [routerLink]="['/autos', auto.id]">
                  CONTACTAR
                </button>
              </div>
            </div>
          </div>

          <!-- Sin resultados -->
          <div class="no-results" *ngIf="autosFiltrados.length === 0">
            <h5>No se encontraron autos con los filtros seleccionados</h5>
            <button class="btn btn-primary mt-3" (click)="limpiarFiltros()">
              Limpiar Filtros
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- VISTA ADMIN (mantener funcionalidad existente) -->
<div *ngIf="authService.isAdmin()" class="container-fluid py-4">
  <div class="container">
    <h1 class="h2 fw-bold mb-4">ðŸš— GestiÃ³n de Autos</h1>
    
    <!-- VISTAS (Solo Admin) -->
    <div class="btn-group mb-4" role="group">
      <button type="button" 
              class="btn btn-outline-primary" 
              [class.active]="vistaActual === 'disponibles'"
              (click)="cambiarVista('disponibles')">
        âœ… Disponibles ({{ contadores.disponibles }})
      </button>
      <button type="button" 
              class="btn btn-outline-primary" 
              [class.active]="vistaActual === 'vendidos'"
              (click)="cambiarVista('vendidos')">
        ðŸ’° Vendidos ({{ contadores.vendidos }})
      </button>
      <button type="button" 
              class="btn btn-outline-primary" 
              [class.active]="vistaActual === 'todos'"
              (click)="cambiarVista('todos')">
        ðŸ“Š Todos ({{ contadores.todos }})
      </button>
    </div>

    <!-- LOADING -->
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-3 text-muted">Cargando autos...</p>
    </div>

    <!-- ERROR -->
    <div *ngIf="error && !loading" class="alert alert-danger">
      {{ error }}
    </div>

    <!-- GRID DE AUTOS ADMIN -->
    <div class="row g-4" *ngIf="!loading && !error">
        <div *ngFor="let auto of autos" class="col-lg-4 col-md-6">
          <div class="card h-100 shadow-sm" [class.opacity-75]="!auto.disponible">
            <img [src]="auto.imagenes?.[0] || getDefaultImage(auto)" 
                 [alt]="auto.modelo"
                 (error)="onImageError($event, auto)"
                 class="card-img-top" 
                 style="height: 250px; object-fit: cover;">
            <div class="card-body">
            <h5 class="card-title">{{ auto.marca?.nombre }} {{ auto.modelo }}</h5>
            <p class="card-text">AÃ±o: {{ auto.anio }} | Precio: S/ {{ auto.precio | number:'1.0-0' }}</p>
            <div class="btn-group w-100">
              <button class="btn btn-sm btn-primary" [routerLink]="['/admin/autos/editar', auto.id]">
                Editar
              </button>
              <button class="btn btn-sm btn-danger" (click)="eliminarAuto(auto)">
                Eliminar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
